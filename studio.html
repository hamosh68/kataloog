<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø­Ø¬ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --success: #10b981; }
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; margin: 0; padding: 15px; direction: rtl; }
        .card { background: white; border-radius: 20px; padding: 20px; max-width: 500px; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 1rem; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-scan { background: #4b5563; }
        .btn-camera { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
        .btn-save { background: var(--success); }
        .preview-win { width: 100%; aspect-ratio: 1/1; background: #fff; border: 2px solid #e2e8f0; border-radius: 15px; margin-bottom: 15px; position: relative; overflow: hidden; display: none; }
        canvas { width: 100%; height: 100%; object-fit: contain; }
        input, select { width: 100%; padding: 14px; border: 1px solid #d1d5db; border-radius: 10px; margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; text-align: center; font-family: 'Cairo'; }
        #log-area { background: #0f172a; color: #38bdf8; padding: 12px; border-radius: 10px; font-family: monospace; font-size: 11px; white-space: pre-wrap; max-height: 100px; overflow-y: auto; margin-top: 10px; }
        .loader { display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 10; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align: center; margin-top:0;">ğŸ’ Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø­Ø¬ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</h2>

    <input type="file" id="scan-file" accept="image/*" capture="environment" hidden onchange="doScan(this)">
    <button class="btn btn-scan" onclick="document.getElementById('scan-file').click()">ğŸ” 1. ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <input type="text" id="p_code" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§">

    <input type="text" id="p_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    
    <div style="display:flex; gap:10px;">
        <select id="p_brand">
            <option value="Stabilo">Stabilo</option>
            <option value="Faber-Castell">Faber-Castell</option>
            <option value="IBC">IBC</option>
            <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
        </select>
        <input type="number" id="p_price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
    </div>

    <input type="file" id="item-file" accept="image/*" capture="environment" hidden onchange="doRemoveAndEnhance(this)">
    <button class="btn btn-camera" onclick="document.getElementById('item-file').click()">ğŸ“¸ 2. ØªØµÙˆÙŠØ± Ø§Ù„ØµÙ†Ù (Ø¹Ø²Ù„ Remove.bg)</button>

    <div id="preview-container" class="preview-win">
        <div id="loader" class="loader"><div class="spinner"></div><br><b>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©...</b></div>
        <canvas id="studioCanvas"></canvas>
    </div>

    <button class="btn btn-save" onclick="doFinalSave()">âœ… Ø­ÙØ¸ ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© HD</button>

    <div id="log-area">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù†Ø³Ø®...</div>
    <button class="btn" style="background:#1e293b; margin-top:10px;" onclick="copyLogs()">ğŸ“‹ Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„Ù€ GitHub</button>
</div>

<script>
    const canvas = document.getElementById('studioCanvas');
    const ctx = canvas.getContext('2d');
    const KEY_AI = "9dNHesr9DC48muANXdHzXJ7W"; 

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø³ÙƒØ§Ù†
    async function doScan(input) {
        if (!input.files[0]) return;
        document.getElementById('p_code').value = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...";
        const scanner = new Html5Qrcode("p_code");
        try {
            const res = await scanner.scanFile(input.files[0], true);
            document.getElementById('p_code').value = res;
        } catch (e) { alert("Ø£Ø¹Ø¯ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨ÙˆØ¶ÙˆØ­"); document.getElementById('p_code').value = ""; }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø²Ù„ (Ù…Ø­Ø±ÙƒÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ù…ÙØ¶Ù„)
    async function doRemoveAndEnhance(input) {
        if (!input.files[0]) return;
        const loader = document.getElementById('loader');
        const preview = document.getElementById('preview-container');
        loader.style.display = "flex";
        preview.style.display = "block";

        const formData = new FormData();
        formData.append('image_file', input.files[0]);
        formData.append('size', 'preview'); // ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ÙˆÙŠØ´ØªØºÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠÙÙŠÙˆ

        try {
            const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: { 'X-Api-Key': KEY_AI },
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                drawAndEnhance(URL.createObjectURL(blob));
            } else {
                alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø±ØµÙŠØ¯ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† Ø¹Ø²Ù„");
                drawAndEnhance(URL.createObjectURL(input.files[0]));
            }
        } catch (err) { drawAndEnhance(URL.createObjectURL(input.files[0])); }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø¬ÙˆØ¯Ø© HD
    function drawAndEnhance(url) {
        const img = new Image();
        img.src = url;
        img.onload = () => {
            canvas.width = 2500;
            canvas.height = 2500;
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, 2500, 2500);

            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            // ÙÙ„ØªØ± ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            ctx.filter = 'contrast(1.15) brightness(1.05) saturate(1.1)';
            
            let ratio = Math.min(2500 / img.width, 2500 / img.height);
            let w = img.width * ratio;
            let h = img.height * ratio;
            ctx.drawImage(img, (2500 - w) / 2, (2500 - h) / 2, w, h);
            
            ctx.filter = 'none';
            document.getElementById('loader').style.display = "none";
        };
    }

    function doFinalSave() {
        const code = document.getElementById('p_code').value;
        const name = document.getElementById('p_name').value;
        const brand = document.getElementById('p_brand').value;
        const price = document.getElementById('p_price').value || '0.000';

        if (!code || !name) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!");

        const link = document.createElement('a');
        link.download = `${code}.webp`;
        link.href = canvas.toDataURL('image/webp', 0.9);
        link.click();

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø¹Ø±Ø¶Ùƒ
        const line = `{ brand: '${brand}', sub: 'Ø¹Ø§Ù…', code: '${code}', name: '${name}', price: '${price}', image: '${code}.webp' },\n`;
        document.getElementById('log-area').textContent += line;
        
        // ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª Ù„Ù„ØµÙ†Ù Ø§Ù„ØªØ§Ù„ÙŠ
        document.getElementById('p_code').value = "";
        document.getElementById('p_name').value = "";
        document.getElementById('p_price').value = "";
        document.getElementById('preview-container').style.display = "none";
    }

    function copyLogs() {
        navigator.clipboard.writeText(document.getElementById('log-area').textContent);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø£ÙƒÙˆØ§Ø¯!");
    }
</script>
</body>
</html>